%--------------------------------------------------------------------
\chapter{Керування пам'яттю} \label{chap:mem}
%--------------------------------------------------------------------

        \begin{verse}\it
	Minnet, jag har tappat mitt minne, \\
	\"<ar jag svensk eller finne \\
	kommer inte ih\aa g\dots \\
	(Bosse \">Osterberg) \\
        \rm\end{verse}

	\noindent
	Цей розд╕л опису╓ принципи роботи менеджера пам'ят╕ Л╕накса,
	так╕ як в╕ртуальна пам'ять та дисковий кеш. Описан╕
	призначення, принципи роботи та т╕ детал╕, як╕ треба приймати
	до уваги системному адм╕н╕стратору. 

\section{Що таке в╕ртуальна пам'ять?}

	Л╕накс п╕дтриму╓ \defin{в╕ртуальну пам'ять}. При використанн╕
	диску, як уявного розширення до ф╕зично╖ пам'ят╕, ефективний
	розм╕р пам'ят╕, що використову╓ться зроста╓ в╕дпов╕дно. Якщо
	як╕сь розд╕ли пам'ят╕ не використовуються на даний момент,
	ядро запише ╖х на диск ╕ зможе використати зв╕льнений в
	оперативн╕й пам'ят╕ прост╕р п╕д щось ╕нше. Якщо скинут╕ на
	диск област╕ пам'ят╕ знадобляться знову, ядро прочита╓ ╖х
	знову з диску в пам'ять. Все це викону╓ться непом╕тно для
	користувача. Програми в Л╕накс╕ бачать т╕льки, що система ма╓
	б╕льший об'╓м пам'ят╕ ╕ нав╕ть не п╕дозрюють, як╕ саме з
	д╕лянок пам'ят╕ знаходяться в даний момент на диску, а як╕ в
	оперативн╕й пам'ят╕. Звичайно ж, читання та запис на диск ╓
	значно пов╕льн╕шими, пор╕вняно з оперативною пам'яттю (в
	тисяч╕ раз╕в пов╕льн╕ше). Тому при користуванн╕ в╕ртуальною
	пам'яттю програми будуть працювати пов╕льн╕ше. Та частина
	диску, що використову╓ться для в╕ртульно╖ пам'ят╕ назива╓ться
	\defin{простором своп╕н╜у}.

	Для своп╕н╜у Л╕накс може використовувати або звичайний файл в
	файлов╕й систем╕, або окремий розд╕л, вид╕лений спец╕ально для
	цього на диску. В╕ртуальна пам'ять з використанням п╕дрозд╕лу
	на диску працю╓ швидше, н╕ж своп╕н╜ у файл. Але зм╕нити розм╕р
	файлу для своп╕н╜у набагато легше ╕ швидше, ╕ це не потребу╓
	переформатування диску (╕, можливо, встановлення всього з
	самого початку). Якщо Ви зна╓те, ск╕льки простору п╕д своп╕н╜
	Вам потр╕бно, Ви можете в╕дразу форматувати весь диск з
	вид╕ленням п╕дрозд╕лу п╕д своп╕н╜, але якщо Ви ще непевн╕, то
	Вам краще попробувати спочатку попрацювати з файлом,
	покористуватися системою деякий час ╕ пот╕м вир╕шити, який
	розм╕р розд╕лу для своп╕н╜у Вам потр╕бен.

	Кр╕м того варто знати, що Л╕накс може користуватися к╕лькома
	областями для своп╕н╜у одночасно. Це означа╓, що, якщо велик╕
	розд╕ли для своп╕н╜у потр╕бн╕ т╕льки ╕нколи, зам╕сть того, щоб
	тримати ╖х пост╕йно, можна додавати ц╕ област╕ т╕льки на той
	час, коли саме вони необх╕дн╕.

	Дещо про терм╕ноло╜╕ю: комп'ютерн╕ спец╕ал╕сти в╕др╕зняють два
	р╕зних режими користування в╕ртувальною пам'яттю - своп╕н╜
	\intnote{swapping} (перенесення област╕ пам'ят╕ ц╕лого процесу
	на диск) та пейдж╕н╜\intnote{paging} (запис на диск окремих
	стор╕нок пам'ят╕, непотр╕бних в даний момент). Пейдж╕н╜ ╓
	б╕льш ефективним, ╕ це ╓ саме те, що робить Л╕накс. Але за
	традиц╕╓ю вс╕ називають це своп╕н╜ом.\footnote{╤ цим без
	потреби доводять маститих метр╕в комп'ютеризац╕╖ до стану
	кип╕ння.}
	

\section{Створення простору для своп╕н╜у}

	Файл для своп╕н╜у - це самий звичайний файл з точки зору
	ядра. ╢дина р╕ч, яка ма╓ значення для ядра, це те, що цей файл
	не ма╓ д╕рок ╕ що в╕н приготований для своп╕н╜у командою
	\cmd{mkswap}. Однак, цей файл повинен бути на локальному
	диску, тобто не може знаходитись на файлов╕й систем╕
	NFS\intnote{Що ╓ надзвичайним недол╕ком Л╕накса пор╕вняно з
	SunOS чи Solaris. Маючи можлив╕сть створювати своп-файл на NFS
	Ви можете створювати бездисков╕ кл╕╓нти - тобто робоч╕
	станц╕╖, як╕ можуть завантажуватись з мереж╕, монтувати вс╕
	файлов╕ системи через NSF з сервера та мати своп-файл
	змонтований так само з сервера. Перш╕ дв╕ пункти можлив╕ в
	Л╕накс╕, але неможлив╕сть створення своп-файлу через NFS
	обмежу╓ робочу пам'ять бездискового Л╕накс-кл╕╓нта до ф╕зично╖
	пам'ят╕ локального комп'ютера, що, звичайно ж, в багатьох
	випадках не ╓ достатн╕м}.

	Зам╕тка про д╕рки ╓ важливою. Своп-файл створю╓ться на диску
	таким чином, що ядро ма╓ можлив╕сть швидко "<скинути">
	стор╕нку з пам'ят╕ на диск, не проходячи через весь процес
	вид╕лення сектора на диску. Оск╕льки д╕рка в файл╕ означа╓, що
	для певного шматка файлу не зарезервовано блок╕в на диску,
	ядро буде записувати ╕нформац╕ю в не╕снуюч╕ блоки (можливо
	зайнят╕ ╕ншими файлвми).

	В╕рний спос╕б для створення файлу своп╕н╜у ╓ такий:
		%
		\begin{quote}\tt
\verb|$| {\sl dd if=/dev/zero of=/extra-swap bs=1024 count=1024}\\
\verb|1024+0 records in| \\
\verb|1024+0 records out| \\
\verb|$|
		\rm\end{quote}
		%

	де \fn{/extra-swap} - це назва файлу, призначеного п╕д своп╕н╜,
	а його розм╕р дано п╕сля \texttt{count=}. Краще всього, якщо
	розм╕р буде кратний чотирьом, бо ядро скида╓ у своп-файл стор╕нки
	пам'ят╕ розм╕ром в 4 к╕лобайти. Якщо розм╕р буде не кратним 4,
	то останн╕ к╕лька к╕лобайт не будуть використан╕. 
	
	П╕дрозд╕л для своп╕н╜у теж ╓ самим звичайним п╕дрозд╕лом. В╕н
	створю╓ться точн╕с╕нько, як будь-який ╕нший п╕дрозд╕л. ╢диною
	в╕дм╕нн╕стю ╓ те, що в╕н використову╓ться як сирий диск - без
	файлово╖ системи на ньому. Краще, якщо п╕дрозд╕л, призначений
	п╕д своп╕н╜ буде мати тип 82 - Л╕накс своп-п╕дрозд╕л. Нав╕ть
	при тому, що ядро не зверта╓ уваги на  типи розд╕л╕в, така
	установка зробить список п╕дрозд╕л╕в трохи ч╕тк╕шим.

	П╕сля створення або файлу або п╕дрозд╕лу для своп╕н╜у, на
	ньому потр╕бно записати "<п╕дпис">\intnote{signature}
	своп-файлу. Цей п╕дпис м╕стить деяку адм╕н╕стративну
	╕нформац╕ю ╕ в╕н використову╓ться ядром. Команда для створення
	такого п╕дпису ╓ \cmd{mkswap}:
		%
		\begin{quote}\tt
\verb|$| {\sl mkswap /extra-swap 1024} \\
\verb|Setting up swapspace, size = 1044480 bytes| \\
\verb|$|
		\rm\end{quote}
		%

	В╕дм╕тимо, що нав╕ть п╕сля ц╕╓╖ операц╕╖ своп-прост╕р все ще
	не використову╓ться - в╕н ╕сну╓, але ядро не використову╓ його
	як в╕ртуальну пам'ять. 

	Будьте дуже обережними при використанн╕ команди \cmd{mkswap},
	оск╕льки вона не перев╕ря╓, чи використову╓ться цей дисковий
	прост╕р чимось ╕ще. \emph{ Ви можете запросто знищити важлив╕
	файли ╕ ц╕л╕ розд╕ли диску ц╕╓ю командою} На щастя командою
	\cmd{mkswap} потр╕бно користуватися т╕льки при встановленн╕
	системи. 
	
	Менеджер пам'ят╕ Л╕накса обмежу╓ розм╕р кожно╖ д╕лянки
	своп-простору до приблизно 127~МБайт (з р╕зних техн╕чних
	причин справжн╕й розм╕р ╓ $(4096-10)\times 8\times 4096 =
	133890048$ байт чи 127,6875 мегабайт). Однак, можна
	користуватися ш╕стнадцятьма такими розд╕лами одночасно, що
	робить максимальний розм╕р простору для своп╕н╜у р╕вним
	приблизно 2~╫╕╜абайтам.\footnote{╫╕╜абайт тут, ╜╕╜абайт там,
	скоро ми будемо говорити про справжню пам'ять.}


\section{Використання своп╕н╜у}

	П╕дготований для використання прост╕р своп╕н╜у можна привести
	в д╕ю командою \cmd{swapon}. Ця команда каже ядру, що
	своп-прост╕р можна використовувати. Параметром до команди
	да╓ться маршрут, вказуючий яким простором саме
	користуватись. Отже, для того, щоб почати своп╕н╜ на
	тимчасовому файл╕, можна скористуватися такою командою:
		%
		\begin{quote}\tt
\verb|$| {\sl swapon /extra-swap} \\
\verb|$|
		\rm\end{quote}
		%

	Розд╕ли ╕ файли для своп╕н╜у будуть п╕дключатися 
	автоматично при старт╕ системи, якщо вони вказан╕ в файл╕
	\fn{/etc/fstab}.
		%
		\begin{quote}\tt
\verb|/dev/hda8        none        swap        sw     0     0| \\
\verb|/swapfile        none        swap        sw     0     0|
		\rm\end{quote}
		%

	Стартовий скрипт викона╓ команду \texttt{swapon -a}, яка почне
	своп╕н╜ на вс╕х файлах ╕ розд╕лах своп╕н╜у, вказаних в
	\fn{/etc/fstab}. Отже, командою \cmd{swapon} потр╕бно
	користуватися т╕льки тод╕, коли виника╓ потреба в додатковому
	простор╕ для своп╕н╜у.

	Просл╕дкувати за використанням своп-простору можна за
	допомогою команди \cmd{free}. Вона скаже ск╕льки всього
	використову╓ться своп-пам'ят╕. 
		%
		\begin{quote}\tt
\verb|$| {\sl free} \\
\verb|             total       used       free     shared    buffers| \\
\verb|Mem:         15152      14896        256      12404       2528| \\
\verb|-/+ buffers:            12368       2784| \\
\verb|Swap:        32452       6684      25768| \\
\verb|$|
		\rm\end{quote}
		%
	
	Перший рядок (\verb|Mem:|) показу╓ ск╕льки ╓ ф╕зично╖
	пам'ят╕. Стовпчик "<всього">\intnote{total} не в╕добража╓
	пам'ять, яка використову╓ться ядром, яка завжди приблизно
	дор╕вню╓ мегабайту. Стовпчик використано╖
	пам'ят╕\intnote{used} показу╓ к╕льк╕сть пам'ят╕, що
	використову╓ться (другий рядок не раху╓ буфер╕в). ╤ стовчик
	в╕льно╖ пам'ят╕ показу╓ пам'ять, що не використову╓ться
	зовс╕м. Стовпчик "<shared"> вказу╓ об'╓м пам'ят╕, що сп╕льно
	використову╓ться к╕лькома процесами - чим б╕льше, тим
	краще. Стовпчик буфер╕в демонстру╓ розм╕р дискових буфер╕в на
	даний момент. 
	
	Останн╕й рядок (\verb|Swap:|) показу╓ всю ту ж ╕нформац╕ю
	в╕дносно своп-простору. Якщо в цьому рядку стоять суц╕льн╕
	нул╕ - своп╕н╜ не приведено в д╕ю. 

	Ту ж саму ╕нформац╕ю можна отримати командою \cmd{top} або
	подивившись файл \fn{/proc/meminfo} в файлов╕й систем╕
	\texttt{proc}. Поки що неможливо отримати ╕нформац╕ю про
	конкретне використання то╖ чи ╕ншо╖ д╕лянки своп-простору. 
	
	Припинити використання своп-простору можна командою
	\cmd{swapoff}. Найчаст╕ше нема╓ потреби цього робити за
	виключенням тимчасових своп файл╕в. Вс╕ стор╕нки, що м╕стяться
	в даний час на дан╕й д╕лянц╕ своп простору спочатку будуть
	перенесен╕ в пам'ять. Якщо ф╕зично╖ пам'ят╕ не вистача╓ для
	цього, то система скине ц╕ стор╕нки на якусь ╕ншу д╕лянку
	свопу. Якщо ж в╕ртуально╖ пам'ят╕ не досить для того, щоб
	втримати вс╕ стор╕нки в пам'ят╕ система безк╕нечно перекидати
	стор╕нки пам'ят╕ туди-сюди, з диску в пам'ять ╕ з пам'ят╕
	знову на диск.  \intnote{Можливо, що багато процес╕в просто
	п╕дуть у см╕тник. Дуже часто це вигляда╓, як установка Windows
	95 - комп'ютер зда╓ться п╕дв╕шеним у безпов╕тряному простор╕.}
	Через довгий пер╕од часу вона повинна в╕д╕йти, але на протяз╕
	цього часу в╕д системи не добитися н╕якого толку. Перш, н╕ж
	забирати у системи своп впевн╕ться, що систем╕ досить пам'ят╕,
	щоб вижити (за допомогою команди \cmd{free}).

%*************************
% 	A swap space can be removed from use with \cmd{swapoff}.
%	It is usually not necessary to do it, except for temporary
%	swap spaces.
%	Any pages in use in the swap space are swapped in first; if
%	there is not sufficient physical memory to hold them, they will
%	then be swapped out (to some other swap space).  
%	If there is not enough virtual memory to hold all of the pages
%	Linux will start to thrash; after a long while it should
%	recover, but meanwhile the system is unusable.  You should
%	check (e.g., with \cmd{free}) that there is enough free
%	memory before removing a swap space from use.
%****************************
	
	Весь прост╕р своп╕н╜у, приведений в д╕ю командою
	\texttt{swapon -a}, так само можна деактив╕зувати одн╕╓ю
	командою \texttt{swapoff -a}. Вона шука╓ в файл╕
	\fn{/etc/fstab}, що потр╕бно деактив╕зувати. Весь
	своп-прост╕р, що було приведено в д╕ю вручну продовжуватиме
	працювати \begin{intnote}В╕дм╕нност╕ Л╕накса ╕ SunOS/Solaris. В SunOS
	взагал╕ неможливо працювати без своп-простору. Якщо при старт╕
	система бачить, що не вид╕лено простору для своп╕н╜у, вона
	спиня╓ться ╕ чека╓ на те, що користувач вкаже, яким розд╕лом
	користуватися для своп╕н╜у. SunOS ма╓ ╓дину команду
	\cmd{swapon}, ╕з синтаксисом таким самим, як ╕ Л╕накс. Але
	команди \cmd{swapoff} в SunOS нема╓, тобто деактив╕зувати своп
	прост╕р п╕д час роботи системи неможливо. Solaris багато в
	чому под╕бна до Л╕накса в цьому в╕дношенн╕, т╕льки ма╓ ╕нший
	формат команди. Команда для керування свопом в Solaris'╕ одна
	╓дина - \cmd{swap}, але коли використову╓ться з р╕зними
	параметрами викону╓ те ж, що ╕ \cmd{swapon}, \cmd{swapoff} та
	\cmd{free} (в деякому в╕дношенн╕ - \cmd{swap -l} показу╓
	актив╕зован╕ своп п╕дрозд╕ли та файли в систем╕, та наск╕льки
	вони використовуються, без показу проценту використання
	ф╕зично╖ пам'ят╕.) 

	Кр╕м того, як уже в╕дм╕чалося ран╕ше по тексту, ╕ SunOS ╕
	Solaris вм╕ють користуватися NFS для створення файл╕в своп╕н╜у
	на NFS сервер╕.\end{intnote}.

	╤нколи, нав╕ть при величезному об'╓м╕ невикористано╖ ф╕зично╖
	пам'ят╕, своп пам'ять виявля╓ться зайнятою. Це трапля╓ться,
	якщо в якийсь момент деякий процес вимагав багато пам'ят╕ ╕
	стор╕нки пам'ят╕ виявилися скинутими на диск.  П╕сля
	того, як процес зак╕нчив свою роботу, т╕ стор╕нки, як╕ були
	скинут╕ в своп, так ╕ залишаються там без ╖х автоматично╖
	очистки, до того часу, поки зайнята ними пам'ять не знадобиться
	для ╕ншого процесу. Про це нема╓ зовс╕м н╕яко╖ причини
	турбуватися, але, якщо Ви про це зна╓те, у Вас може бути трохи
	спок╕йн╕ше на душ╕. 

\section{Сп╕льне використання простору своп╕н╜у з ╕ншими системами}

	В╕ртуальна пам'ять використову╓ться багатьма
	системами. Оск╕льки вона потр╕бна кожн╕й систем╕ т╕льки в той
	час, коли ця система працю╓, то тод╕, коли дана система не
	активна, дисковий прост╕р, вид╕лений п╕д в╕ртуальну пам'ять,
	гуля╓. Було б б╕льш ефективним, якби малася можлив╕сть
	користуватися одним ╕ тим, же дисковим простором в к╕лькох
	операц╕йних системах. Це виявля╓ться можливим, але вимага╓
	деяких хакерських д╕й в╕д системного адм╕н╕стратора. Деяк╕
	поради щодо того, як це зробити ╓ в Tips-HOWTO.

\section{Вид╕лення своп простору} \label{sec:swap-alloc}

	Дехто радить мати своп пам'ять як м╕н╕мум вдв╕ч╕ б╕льшою в╕д
	ф╕зично╖ пам'ят╕ системи, але це застар╕ла порада
\begin{intnote}
%
	Для того, щоб зрозум╕ти зв╕дки така порада з'явилася -
	дек╕лька сл╕в з ╕стор╕╖. Юн╕кси попередн╕х рок╕в користувалися
	своп-п╕дрозд╕лом системи для дампу пам'ят╕. 

	П╕д час навчання в ун╕верситет╕ я п╕дробляв оператором на
	М4030, ╕ к╕лька раз╕в мен╕ довелося бачити, як виглядав дамп
	пам'ят╕ там. П╕д час краху (в Юн╕кс╕ кажуть, що ядро виклика╓
	стан пан╕ки, або пан╕ку╓) системи М4030 намагалася скинути
	поточний стан \emph{ вс╕╓╖} сво╓╖ пам'ят╕ на пап╕р - тобто
	дамп пам'ят╕ виглядав як неск╕нченне друкування поток╕в
	ш╕стнадцядкових код╕в.  К╕лометри ╕ к╕лограми паперу ╕з
	стовпчиками чисел по вс╕й його ширин╕. 
	
	Приблизно те ж саме робили ╕ Юн╕кси, з ╓диною в╕дм╕нн╕стю, що
	вся пам'ять скидалася на диск. Диск в цьому випадку
	використовувася, як сирий пристр╕й без файлово╖ системи (важко
	вимагати в╕д системи, щоб в стан╕ пан╕ки вона ще дбала про
	як╕сь там файли). Пам'ять скидалася на своп розд╕л диску ╕
	робиться в╕д гори до низу - тобто з протилежного к╕нця до
	того, з якого система почина╓ користуватися диском п╕д
	своп╕н╜. Коли систему п╕сля цього все таки вдасться
	завантажити, то в верхн╕й частин╕ розд╕лу ще залиша╓ться образ
	пам'ят╕ системи в╕д часу пан╕ки, нав╕ть якщо система вже
	почала своп╕н╜ деяких стор╕нок пам'ят╕ на диск. Л╕накс не
	користу╓ться такою схемою дампу пам'ят╕, тому рекомендац╕╖
	мати своп вдв╕ч╕ б╕льший в╕д ф╕зично╖ пам'ят╕ не мають п╕д
	собою основи.

	\end{intnote}. Ось к╕лька рекомендац╕й щодо того, як в╕рно визначити об'╓м
	в╕ртуально╖ пам'ят╕:

    \begin{enumerate}

    \item

	Визнач╕ться ╕з загальним об'╓мом пам'ят╕, яка Вам потр╕бна. Це
	найб╕льший об'╓м пам'ят╕, який Вам можливо знадобиться
	коли-небудь. Тобто, це сума вс╕х об'╓м╕в вс╕х програм, якими
	Ви хочете користуватися одночасно. Можна д╕знатися про це,
	запустивши вс╕ програми, якими Ви захочете одночасно
	користуватися.

	Наприклад, якщо Ви хочете працювати в X, Вам потр╕бно вид╕лити
	п╕д це б╕ля 8~МБайт, gcc сам вимага╓ к╕лькох ме╜абайт (деяк╕
	файли вимагають надзвичайно великого об'╓му - до десятк╕в
	ма╜абайт, але звичайно близько чотирьох ма╓ бути досить), ╕
	так дал╕. Ядро займе б╕ля ме╜абайта, командн╕ оболонки
	\intnote{shell} та деяк╕ невелик╕ програмки-ут╕л╕тки можливо
	потребують к╕лька сотень к╕лобайт (скаж╕мо ме╜абайт вс╕
	разом). Нема╓ н╕яко╖ потреби вираховувати дуже точн╕ величини,
	досить приблизн╕ округлення - це саме те що потр╕бно в цьому
	випадку. Але при цьому краще б бути трошки песим╕стом.

	Пам'ятайте, що якщо системою будуть користуватися к╕лька людей
	одночасно, вони вс╕ будуть користуватися пам'яттю. Однак, якщо
	дво╓ користувач╕в користуються одн╕╓ю ╕ т╕╓ю ж програмою
	одночасно, загальне використання пам'ят╕ при цьому не вдв╕ч╕
	б╕льше, оск╕льки деяк╕ стор╕нки пам'ят╕ використовуються
	сп╕льно - вс╕ сп╕льн╕ б╕бл╕отеки та вс╕ програми в пам'ят╕
	╕снують т╕льки в одному екземпляр╕.

	\cmd{free} та \cmd{ps} дадуть Вам уяву про потреби пам'ят╕. 

    \item

	Додайте дещо на всяк випадок. Обрахований об'╓м може бути не
	достатньо точним, через те, що: Ви забули деяк╕ програми, як╕
	тепер Вам просто необх╕дно додати до попереднього списку. Тому
	непогано б мати деяку в╕льну пам'ять про всяк
	випадок. Парочка-друга ме╜абайт ма╓ бути досить. (Звичайно ж,
	краще мати б╕льше, н╕ж менше, але пам'ятайте, що невикористана
	в╕ртувальна пам'ять - просто загублена, тому нема╓ сенсу
	створювати надто великий запас. Див╕ться дал╕ про додання
	в╕ртуально╖ пам'ят╕ в процес╕ роботи. Кр╕м того, оск╕льки
	завжди при╓мн╕ше мати справу з круглими числами, можна
	округлити обраховане число до найближчого ц╕лого ме╜абайту.
	
    \item

	Обрахувавши сво╖ потреби в пам'ят╕ Ви будете знати, ск╕льки
	пам'ят╕ потр╕бно всього. Щоб д╕знатися потр╕бний розм╕р
	своп-прост╕ру, просто в╕дн╕м╕ть в╕д цього числа об'╓м Вашо╖
	оперативно╖ пам'ят╕. (В деяких верс╕ях Юн╕кса, Вам потр╕бно
	вид╕лити прост╕р п╕д ф╕зичну пам'ять також, тобто об'╓м
	пам'ят╕, обрахований на другому кроц╕, ╕ буде тим, що потр╕бно
	вид╕лити п╕д своп. Тобто, Вам не потр╕бно н╕чого
	в╕дн╕мати. 

    \item

	Якщо обчислена таким чином своп-пам'ять ╓ занадто великою
	(б╕льше, н╕ж у к╕лька раз╕в б╕льша за ф╕зичну пам'ять),
	скор╕ше всього Вам варто вкласти грош╕ в додаткову ф╕зичну
	пам'ять, ╕накше швидк╕сть роботи системи буде незадов╕льною. 

    \end{enumerate}

	Хоча б яку небудь своп-пам'ять варто мати в будь-якому
	випадку, нав╕ть якщо Ваш╕ обрахунки показують, що Вам вона не
	потр╕бна. Л╕накс користу╓ться в╕ртульною пам'яттю досить
	агресивно, щоб мати якомога б╕льше ф╕зично╖ пам'ят╕
	в╕льною. Л╕накс викида╓ на диск т╕ стор╕нки пам'ят╕, як╕ не
	використовуються на даний момент, щоб зв╕льнити пам'ять п╕д
	майбутн╕й своп╕н╜, нав╕ть, якщо н╕чого його не потребу╓ на
	даний момент. Таким чином майбутн╕й своп╕н╜ може бути
	зроблений швидше - не потр╕бно чекати на те, що стор╕нки
	будуть скинен╕ на диск - це вже було зроблено тод╕, коли диск
	не був н╕чим не зайнятий.

	Своп-прост╕р можна под╕лити м╕ж к╕лькома дисками. В деяких
	випадках це може п╕двищити швидк╕сть роботи, залежно в╕д
	швидкост╕ роботи диск╕в та того, як до диск╕в зд╕йсню╓ться
	доступ. Можливо Вам варто трохи поекспериметувати, але
	пам'ятайте при цьому, що в╕рно експериментувати досить
	важко. Не варто дов╕ряти будь-кому, хто запевнятиме Вас, що та
	чи ╕нша схема ма╓ надзвичайну перевагу над ╕ншою такою ж. 

\section{Буферний кеш}\intnote{The buffer cache}
\label{sec:buffer-cache}

	Швидк╕сть читання з диску\footnote{кр╕м звичайно швидкост╕
	читання з RAM-диску, ╕з зрозум╕лих причин}, ╓ набагато меншою,
	н╕ж швидк╕сть доступу до (справжньо╖) пам'ят╕.  Часто
	трапля╓ться так, що Вам потр╕бно прочитати одн╕ й т╕ ж дан╕
	к╕лька раз╕в з диску на протяз╕ в╕дносно короткого в╕дтинку
	часу. Простий приклад: Ви чита╓те листа, який прийшов
	електронною поштою, пот╕м в╕дкрива╓те цього ж листа в
	редактор╕ для того, щоб дати на нього в╕дпов╕дь, пот╕м
	в╕дкрива╓те програму електонно╖ пошти, яка в╕д╕шле цю
	в╕дпов╕дь. Або ╕нший випадок: ск╕льки раз╕в викону╓ться
	команда \cmd{ls} в систем╕ з багатьма користувачами? Швидк╕сть
	роботи системи можна п╕дняти, якщо читати вс╕ дан╕ з диску
	т╕льки один раз, ╕ тримати ╖х в пам'ят╕ п╕сля цього доти, доки
	вони б╕льше не потр╕бн╕. Таким чином п╕двищу╓ться швидк╕сть
	вс╕х операц╕й читання з диску кр╕м само╖ першо╖. Це називають
	\defin{дисковим буфером}, ╕ пам'ять, яка використову╓ться при
	цьому називають \defin{буферним кешем}.

	Пам'ять дуже часто обмежена, ╕ нав╕ть б╕льше того, ╖╖ часто
	недостатньо. Тому дисковий буфер не вда╓ться зробити достатньо
	великим (тобто, в╕н не може збер╕гати вс╕ дан╕, як╕ Вам
	потр╕бн╕). Коли кеш заповню╓ться, дан╕, до яких не було
	доступу на протяз╕ найдовшого часу стираються, ╕ вив╕льнена
	пам'ять використову╓ться п╕д нов╕ дан╕.

	Дисковий буфер працю╓ також для запису. З одного боку, дан╕
	записан╕ на диск, часто читаються п╕сля цього знову в пам'ять
	(наприклад, програма записана на диск редактором, чита╓ться
	п╕сля цього комп╕лятором). Отож, непогано мати т╕льки-що
	записан╕ дан╕ ╕ в кеш╕ також. З ╕ншого боку, пом╕стивши дан╕
	т╕льки в кеш, ╕ не записуючи насправд╕ ╖х на диск, операц╕я
	запису робиться значно швидшою. Справжн╕й запис на диск
	викону╓ться п╕сля цього, на фон╕ яко╖сь ╕ншо╖ роботи, не
	запов╕льнюючи ╖х роботи.

	Б╕льш╕сть операц╕йних систем мають дисков╕ буфери та кеш (хоча
	в деяких випадках вони називаються ╕накше), але не вс╕ з цих
	систем працюють за одними й тими ж принципами. Деяк╕ з них ╓ з
	\defin{ наскр╕зним записом}\intnote{write-through} - дан╕
	записуються на диск без затримки (але, звичайно ж, тримаються
	в кеш╕). Кеш, у якому запис в╕дбува╓ться п╕зн╕ше, назива╓ться
	\defin{кешем з в╕дкладеним записом}. В╕дкладений запис значно
	ефективн╕ший, н╕ж наскр╕зний запис, але в той же час, б╕льш
	схильний до помилок: якщо щось негаразд з системою - або зника╓
	напруга (хтось висмикнув шнур з розетки), або дискету вийняли
	з приводу до того, як дан╕ з буферу записан╕ на не╖ -  вс╕ дан╕,
	як╕ були в буфер╕ на цей момент, загублен╕. ╤нколи це нав╕ть
	може означати, що файлова система на диску (якщо така була
	там) не в повному порядку. Бо не записан╕ на диск дан╕ можуть
	бути деякими контрольними даними файлово╖ системи.

	Через це не можна вимикати систему без виконання в╕дпов╕дно╖
	процедури вимикання (див. п╕дрозд╕л~\ref{ch:boothalt}), просто
	витягнувши шнура з розетки.  Дискету з дисководу можна
	витягувати т╕льки п╕сля розмонтовування ╖╖, або ж т╕льки п╕сля
	того, як команда, яка виконувала запис на дискету, пов╕домить
	Вам про те, що вона зак╕нчила писати. Команда \cmd{sync}
	\defin{злива╓}\intnote{flushes} буфер, тобто примусово запису╓
	вс╕ незаписан╕ дан╕ на диск, ╕ нею треба користуватися тод╕,
	коли треба впевнитися, що все записано безпечно на диск. В
	системах з традиц╕йними Юн╕ксами ╕сну╓ програма \cmd{update},
	яка викону╓ться в фоновому режим╕ ╕ робить \cmd{sync} кожн╕
	30~секунд, тобто в б╕льшост╕ випадк╕в нема╓ необх╕дност╕
	робити \cmd{sync}. В Л╕накс╕ ╓ ╕нший демон \cmd{bdflush}, який
	робить чист╕шу роботу - в╕н викону╓ \cmd{sync} част╕ше для
	того, щоб запоб╕гти раптовим короткочасним зависанням системи,
	як╕ ╕нколи трапляються при високих нагрузках на диск
	викликаних командою \cmd{sync}.
	
	В Л╕накс╕ \cmd{bdflush} запуска╓ться процесом \cmd{update}. В
	б╕льшост╕ випадк╕в нема╓ причини п╕клуватися про них, але,
	якщо з деяких причин трапля╓ться так, що демон \cmd{bdflush}
	вмира╓, то ядро видасть попередження про це ╕ його потр╕бно
	запустити вручну (\cmd{/sbin/update}).
	
	Дисковий кеш звичайно трима╓ в буфер╕ не файли, а блоки -
	найменш╕ одиниц╕ дискового вводу/виводу (в Л╕накс╕ вони р╕вн╕
	1~кбайту). Таким чином тримаються в буфер╕ також директор╕╖,
	суперблоки, ╕нформац╕я файлово╖ системи та дан╕ диск╕в без
	файлових систем. 

	Ефективн╕сть кешу в першу чергу залежить в╕д його
	розм╕ру. Занадто  малий кеш практично не робить н╕чого - вс╕ т╕
	дан╕, як╕ в╕н трима╓ в буфер╕ будуть злит╕ на диск ран╕ше, н╕ж
	кеш встигне ╖х використати. Критичний розм╕р кешу залежить в╕д
	того, ск╕льки даних чита╓ться ╕ запису╓ться, ╕ як часто
	потр╕бен доступ до одних ╕ тих же даних. ╢диний шлях це
	д╕знатися - це шлях експерименту.

	Якщо дисковий кеш ма╓ ф╕ксований розм╕р, то його надм╕рний
	розм╕р теж знижу╓ ефективн╕сть роботи. Кеш забира╓ оперативну
	пам'ять в╕д системи, пам'ять ста╓ меншою, що в свою чергу
	приводить до п╕двищення частоти своп╕н╜у, а своп╕н╜ - такий же
	пов╕льний, як ╕ ╕нш╕ дисков╕ перац╕╖. Для п╕двищення
	ефективност╕ використання пам'ят╕ Л╕накс автоматично
	використову╓ всю в╕льну пам'ять п╕д дисковий кеш, ╕
	автоматично зменшу╓ розм╕р кешу, коли програмам потр╕бно
	б╕льше пам'ят╕.

	В Л╕накс╕ в╕д адм╕н╕стратора не вимага╓ться н╕яких додаткових
	д╕й для користування кешем - все в╕дбува╓ться
	автоматично. Кр╕м вимикання комп'ютера за правилами та
	виймання дискети з дисководу тод╕, коли потр╕бно, Вам нема╓
	про що турбуватися.

