%--------------------------------------------------------------------
%\chapter[Системний час]{П╕дримка в╕рного часу в систем╕} \label{chap:time}
\chapter{П╕дримка в╕рного часу в систем╕} \label{chap:time}
%--------------------------------------------------------------------

        \begin{verse}\it

	Час - це ╕ллюз╕я. Об╕дн╕й час - ╕ллюз╕я вдв╕ч╕. \\
	(Ду╜лас Адамс.) \\
        \rm\end{verse}

	\noindent

	Цей розд╕л поясню╓ як система з Л╕наксом п╕дтриму╓ час, ╕ що
	Вам потр╕бно для того, щоб не мати проблем. В б╕льшост╕
	випадк╕в Вам не потр╕бно робити н╕чого стосовно п╕дтримки
	часу, але тим не менше непогано було б розум╕ти, що
	в╕дбува╓ться. 

\section{Часов╕ пояси}

	Вим╕р часу базу╓ться на пер╕одичному природньому явищ╕,
	такому, як чередування св╕тлих та темних пер╕од╕в, що
	викликаються обертанням планети. Загальний час, який
	склада╓ться з суми св╕тлого та темного пер╕од╕в завжди
	пост╕йний, хоча довжина дня та ноч╕ зм╕нюються. Одна пост╕йна
	константа - це полудень.

	Полудень - це такий час, коли сонце знаходиться в сво╖й
	найвищий точц╕ - апоге╖. Оск╕льки Земля кругла,\footnote{Як показують
	найнов╕ш╕ досл╕дження} полудень трапля╓ться в р╕зний час в
	р╕зних куточках планети. Це приводить до поняття
	\textbf{м╕сцевого часу}. Люди вим╕рюють час в р╕зних одиницях,
	б╕льш╕сть з яких так або ╕накше прив'язан╕ до природн╕х
	явищ. ╤ до того часу, поки Ви знаходитесь в одному м╕сц╕, для
	Вас не ма╓ н╕якого значення, що м╕сцевий час в╕др╕зня╓ться в╕д
	╕ншого м╕сцевого часу. 

	Як т╕льки у Вас виника╓ потреба сп╕лкуватися з людьми, що
	знаходяться на значн╕й в╕дстан╕ в╕д Вас, Вам потр╕бно
	в╕дшукати сп╕льну точку вим╕ру часу. В наш час люди р╕зних
	кра╖н сп╕лкуються м╕ж собою, тому були вироблен╕ глобальн╕
	стандарти часу. Такий час носить назву \textbf{ун╕версальним
	часом} (universal time, UT або UTC, який ран╕ше називався
	Стандартним часом за ╫р╕нв╕чем, Greenwich Mean Time або GMT,
	бо в╕н був м╕сцевим часом в ╫р╕нв╕ч╕ у Великобритан╕╖). Коли люди, що
	знаходяться в р╕зний часових поясах мають необх╕дн╕сть в
	сп╕лкуванн╕, вони можуть виражати час в ун╕версальному час╕ ╕
	позбутися, таким чином, недорозум╕нь, як╕ можуть траплятися
	в╕д м╕шанини час╕в.

	Кожен м╕сцевий час назива╓ться часовим поясом. Але хоча
	географ╕я ╕ може дозволити вс╕м людям, що мають один ╕ той же
	полудневий час, жити в одному часовому пояс╕, але пол╕тика
	дозволити цього не може. З багатьох причин, багато кра╖н
	користуються \textbf{л╕тн╕м часом}, тобто, вони переставляють
	св╕й годинник, щоб мати б╕льше св╕тлого часу поки вони
	працюють, ╕ пот╕м повертають стр╕лки годинник╕в назад в
	зимовий час. ╤нш╕ кра╖ни цього не роблять. Т╕, як╕ це роблять
	не можуть погодитися, коли саме переводити стр╕лки годинник╕в,
	╕ правила зм╕нюються кожного року. Все це вносить неабияк╕
	складнощ╕ в визначення часових пояс╕в. 
	
	Визначати часов╕ пояси найкраще або за м╕сцем або за р╕зницею
	часу в╕дносно ╫р╕нв╕чського часу. В США та деяких ╕нших
	кра╖нах часов╕ пояси мають назви та абрев╕атури, що
	складаються з трьох л╕тер. Однак, деяк╕ абрев╕атури
	сп╕впадають з ╕ншими, ╕ тому ними не можна
	користуватися, якщо не вказана також ╕ кра╖на. Кращим ╓
	поняття м╕сцевого часу в Гельс╕нк╕, н╕ж, скаж╕мо, м╕сцевий
	сх╕дньо-╓вропейський час, бо не вс╕ кра╖ни сх╕дно╖ ╢вропи
	дотримуються одних ╕ тих же правил.
	
	Л╕накс включа╓ в себе пакет часових зон, в якому ма╓ться
	╕нформац╕я про вс╕ ╕снуюч╕ часов╕ пояси. Ця ╕нформац╕я може
	легко поновлюватися, якщо правила зм╕нюються. Все, що треба
	робити системному адм╕н╕стратору, це вибрати в╕дпов╕дний
	часовий пояс. Кр╕м цього, кожен користувач може встановити
	св╕й власний часовий пояс, оск╕льки багато хто працю╓ з
	комп'ютерами через мережу, знаходячись на величезн╕й в╕дстан╕
	в╕д комп'ютера. При зм╕н╕ правил переходу на л╕тн╕й час в
	Вашому м╕сцевому часовому пояс╕, не забудьте
	зм╕нити хоча б цю ╕нформац╕ю в Ваш╕й Л╕накс систем╕. Кр╕м
	зм╕ни часового поясу в Ваш╕й систем╕ та поновлення системно╖
	╕нформац╕╖ про часов╕ пояси у Вас нема╓ ╕нших турбот щодо
	часу, як у системного ажм╕н╕стратора.
	
	
\section{Програмний та апаратний годинник}

	Персональний комп'ютер ма╓ годинник, який працю╓ в╕д
	батарейки. Дякуючи батарейц╕ годинник в комп'ютер╕ може
	працювати нав╕ть тод╕, коли комп'ютер вимкнений з
	мереж╕. В╕рний час в апаратному годиннику можна встановити з
	в╕кна установки в BIOS'╕, або з будь-яко╖ операц╕йно╖ систми,
	що працю╓ не комп'ютер╕. 

	Ядро Л╕накса веде в╕дл╕к часу незалежно в╕д апаратного
	годинника. П╕д час завантаження системи, Л╕накс встановлю╓ св╕й
	годинник на той же час, що показу╓ апаратний годинник. П╕сля
	цього два годинники працюють незалежно один в╕д одного. Л╕накс
	ма╓ свого власного годинника, бо зв╕ряти час з апаратним дуже
	пов╕льно ╕ складно. 
	
	Годинник в ядр╕ системи завжди показу╓ час в ун╕версальносу
	час╕. Таким чином ядру не треба знати н╕чого про часов╕ пояси
	-- простота орган╕зац╕╖ приводить до б╕льш високо╖ над╕йност╕
	╕ да╓ прост╕ший механ╕зм для поновлення ╕нформац╕╖ про часов╕
	пояси. Кожен процес самост╕йно займа╓ться перетворенням
	поясових час╕в (використовуючи т╕ засоби, як╕ надаються
	пакетом часових пояс╕в).

	Апаратний годинник може бути встановленим як на м╕сцевий час,
	так ╕ на ун╕версальний. Взагал╕, краще мати годинник
	встановленим на ун╕версальний час, бо в цьому випадку Вам не
	потр╕бно переводити Ваш годинник у комп'ютер╕, коли час у
	Вашому пояс╕ переводиться на л╕тн╕й (ун╕версальний час не ма╓
	л╕тнього часу). На жаль, деяк╕ операц╕йн╕ системи (включаючи
	MS-DOS, Windows, OS/2) завжди вважають, що апаратний час
	встановлено у м╕сцевий час зони. Л╕накс може працювати з обома
	установками, але тод╕ треба не забувати переставляти годинник,
	коли л╕тн╕й час вводиться чи в╕дм╕ня╓ться (╕накше апаратний
	годинник не буде показувати м╕сцевий час).
	
\section{В╕дображення та установка часу}

	В систем╕ Деб╕ан (Debian) часовий пояс системи визнача╓ться
	символ╕чною ссилкою \fn{/etc/localtime}. Ця ссилка показу╓ на
	файл даний часового поясу, який опису╓ даний часовий
	пояс. Файли даних часових пояс╕в збер╕гаються в
	\fn{/usr/lib/zoneinfo}. ╤нш╕ комплектац╕╖ Л╕накс╕в можуть
	робити це ╕накше. 

	Користувач може встановити св╕й власний часовий пояс
	встановленням зм╕нно╖ середовища TZ. Якщо ця зм╕нна не
	встановлена, тод╕ вважа╓ться, що часовий пояс користувача той
	же самий, що ╕ у системи. Синтаксис встановлення часово╖
	зм╕нно╖ TZ описаний на стор╕нц╕ \man{tzset} (3). 
	
	Команда \cmd{date} показу╓ час ╕ дату в даний
	момент.\footnote{Будьте обережними з командою \cmd{time}, яка
	\emph{ не} показу╓ час.} Наприклад:
	
%
\begin{quote}\tt
\verb|$| \textsl{date} \\
\verb|Sun Jul 14 21:53:41 EET DST 1996| \\
\verb|$|
\rm\end{quote}
%
	Час зараз: Нед╕ля, 14-го липня 1996 року, близько за десять
	десята вечора в часовому пояс╕, що назива╓ться "<EET DST"> (це
	може бути л╕тн╕й час сх╕дно╖ ╢вропи "--- East European Daylight
	Savings Time). Кр╕м цього \cmd{date} може також показувати
	ун╕версальний час: 
%
\begin{quote}\tt
\verb|$| \textsl{date -u} \\
\verb|Sun Jul 14 18:53:42 UTC 1996| \\
\verb|$|
\rm\end{quote}
%
	\cmd{date} також використову╓ться для переводу програмного
	годинника системи:
%
\begin{quote}\tt
\verb|#| \textsl{date 07142157} \\
\verb|Sun Jul 14 21:57:00 EET DST 1996| \\
\verb|#| \textsl{date} \\
\verb|Sun Jul 14 21:57:02 EET DST 1996| \\
\verb|#|
\rm\end{quote}
%
	Синтаксис команди трохи закручений, тому за деталями
	звертайтесь до стор╕нки п╕дказки \man{date}. Встановлювати час
	може т╕льки \texttt{root}. Не дивлячись на те, що кожен
	користувач може встановлювати св╕й часовий пояс, годинник в
	систем╕ - один на вс╕х
	\begin{intnote}Прочитавши останню фразу не
	можу стримати себе в╕д налету знайомих до болю анекдот╕в
	радянських час╕в: "<Чому протигази лежать на р╕зних поличках?">,
	"<Вони розкладен╕ по парт╕ям">, "<Парт╕я у нас одна "--- поклад╕ть
	протигази вс╕ разом!">\end{intnote}.

	\cmd{date} показу╓ та встановлю╓ т╕льки програмний годинник
	системи. Команда \cmd{clock} може синхрон╕зувати програмний та
	апаратний годинники. Вона використову╓ться п╕д час завантаження
	системи "--- чита╓ апаратний годинник ╕ переводить програмний
	годинник на той же самий час. Якщо Вам потр╕бно зм╕нити обидва
	годинники, Вам спершу треба перевести програмний за допомогою
	\cmd{date}, а пот╕м встановити апаратний за допомогою
	\texttt{clock -w}. 
	
	Параметр \texttt{-u} команди \cmd{clock}  вказу╓ ╖й, що
	апаратний годинник показу╓ ун╕версальний час. Параметром
	\texttt{-u} \emph{ треба} користуватися в╕рно. ╤накше Ваш
	комп'ютер страшенно розгубиться ╕ не буде знати, який же
	насправд╕ час. 

	Годинники треба переводити дуже обережно. Багато що в Юн╕кс╕
	залежить в╕д годинника. Наприклад, демон \cmd{cron} пер╕одично
	викону╓ команди. П╕сля переводу годинника в╕н може
	розгубитися, ╕ не зрозум╕╓: виконувати команду чи н╕. На одн╕й
	з ранн╕х систем Юн╕кс хтось встановив годинник на двадцять
	рок╕в вперед ╕ \cmd{cron} захот╕в виконувати вс╕ пер╕одичн╕
	команди за двадцять рок╕в за один раз. Сучасн╕ верс╕╖
	\cmd{cron}'у вм╕ють в╕рно поводитися з цим, але все одно треба
	бути обережним. Велик╕ стрибки в час╕ вперед та назад б╕льш
	небезпечн╕, н╕ж мал╕.
	\begin{intnote}Особисто мен╕ зда╓ться це
	в╕дноситься до розряду таких соб╕ навколо комп'ютерних
	ба╓чок. Оск╕льки \cmd{cron} зроблений таким чином, що в╕н не
	пам'ята╓ свого стану, то навряд чи в╕н стане виконувати
	команди, т╕льки тому, що хтось переставив годинник. "<Не
	пам'ята╓ стану"> означа╓ ось що: \cmd{cron} не веде н╕яких
	запис╕в про те, як╕ команди виконан╕, а як╕ н╕, ╕ якщо вони
	виконувалися, то коли саме. Працю╓ в╕н так: в╕н пост╕йно
	спить, ╕ просина╓ться кожно╖ хвилини т╕льки для того, щоб
	перев╕рити, чи запланована на \emph{цю} хвилину якась
	команда. Якщо така команда ╓, то в╕н ╖╖ запуска╓ (або ставить
	в чергу на виконання), якщо ж н╕, то в╕н каже вс╕м:
	"<Добран╕ч">, ╕ ╕де спати дал╕ (аж на ц╕лу хвилину). Отже якщо
	хтось, (╕з якимись злими умислами, або ж просто з нев╕гластва)
	переставив годинник на двадцять рок╕в вперед (можливо
	намагаючись таким чином позбутися проблеми 2000 року(?)), то
	\ldots \cmd{cron} прокинеться, подивиться на годинник ╕ почне
	виконувати команди, як╕ запланован╕ на \emph{ ту} хвилину,
	через 20 рок╕в, ╕ нав╕ть не згада╓, як ц╕ 20 рок╕в пролет╕ли,
	╕ чи робив в╕н що-небудь поки вони пройшли чи н╕. Отже, ╓дина
	проблема може бути з \cmd{cron}'ом, т╕льки коли в╕н ставить
	програми в чергу на виконання. Якщо команда з яко╖сь причини
	не викону╓ться за в╕дведений ╖й час (це не значить, що команда
	не \emph{ встигла} виконатися, н╕, просто вона не змогла
	\emph{ запуститися}), то черга команд зб╕льшу╓ться на одну
	команду. Якщо ╕ наступна не викону╓ться, то
	\ldots (див. ран╕ше). З╕ мною особисто був випадок, коли один з
	користувач╕в жал╕вся, що його \cmd{crontab} не працю╓. При
	перев╕рц╕ виявилося, що його \cmd{cron} роботи були
	запланован╕ запускатися кожно╖ хвилини, але з якихось причин
	к╕льканадцять команд не виконалися. Через це черга команд
	переповнилася ╕ зам╕сть того, щоб виконувати запланован╕ на
	дану хвилину команди, \cmd{cron} кожно╖ хвилини жал╕вся (через
	\texttt{/var/adm/messages}):  "<Черга команд занадто довга, не
	можу виконувати наступну команду ╕ тому лягаю знову спати"> -
	при цьому ╕ так занадто довга черга ставала довшою ╕ще на одну
	команду.\end{intnote}


\section{Коли годинник в╕дста╓}

	Програмний годинник в Л╕накс╕ не завжди точний. Його робота
	п╕дтриму╓ться пер╕одичними \textbf{перепинами таймера}, який
	╜енеру╓ться апаратними засобами PC. Якщо система досить сильно
	завантажена, на обробку перепину в╕д таймера може п╕ти занадто
	багато часу, ╕ програмний годинник почина╓ тод╕
	в╕дставати. Апаратний годинник працю╓ незалежно, ╕ в б╕льшост╕
	випадк╕в точн╕ше. Якщо Ви перегружа╓те св╕й комп'ютер часто
	(що трапля╓ться з б╕льш╕стю систем, як╕ не ╓ серверами), Ви
	будете мати досить точний час. 
	
	Якщо Вам потр╕бно в╕дрегулювати апаратний годинник, то
	найпрост╕ше це зробити, перегрузивши комп'ютер, вв╕йшовши в
	BIOS та встановити годинник зв╕дти. Якщо це Вам не п╕дходить,
	встанов╕ть час з \cmd{date} та \cmd{clock} (в так╕й саме
	посл╕довност╕), але будьте готовими до перегрузки системи,
	якщо деяк╕ з ╖╖ частин починають себе дивно поводити. 
	
	Комп'ютер п╕д'╓днаний до мереж╕ (нав╕ть якщо це самий
	звичайний модем) може перев╕ряти св╕й годинник автоматично,
	зв╕ряючись з деякими ╕ншими системами. Якщо деяка система вм╕╓
	п╕дтримувати дуже точний час, то р╕вняючись на не╖ Ваш
	комп'ютер теж буде мати точний час. Це може бути зроблено за
	допомогою команд \cmd{rdate} або \cmd{netdate}. Обидв╕ команди
	зв╕ряють годинник з ╕ншими системами в мереж╕, а \cmd{netdate}
	може зв╕рятися з к╕лькома системами одночасно, ╕ переводити
	м╕сцевий годинник в╕дпов╕дно. Виконуючи ц╕ команди регулярно,
	Ви будете мати дуже точний годинник в Ваш╕й систем╕. 
	
	\meta say something intelligent about NTP
